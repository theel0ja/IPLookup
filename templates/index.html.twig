{% extends "base.html.twig" %}

{% block stylesheets %}
    <style>
        #map {
            width: 100%;
            height: 30em;
            /* z-index: 0; */
        }
        #menu {
            padding: 10px;
            z-index: 1;

            position: absolute;
            top: 0px;
            left: 0px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-body" style="padding: 0px;" id="map-card-body">
            <div id="map"></div>
            <div id="menu" class="btn-group-toggle" data-toggle="buttons">
                <label class="btn btn-primary active" id="streets-btn">
                    <input id="streets" type="radio" name="rtoggle" checked=""> Streets
                </label><label class="btn btn-primary" id="satellite-streets-btn"><!-- TODO: Try to set them to different lines -->
                    <input id='satellite-streets' type='radio' name='rtoggle'> Satellite
                </label>
            </div>
        </div>
    </div>

    {# {% if error == 'bogon' %}
        Bogon!
    {% endif %} #}
    
    <div>
        <table class="table">
            <!--<thead>
                <tr>
                <th scope="col">#</th>
                <th scope="col">First Name</th>
                <th scope="col">Last Name</th>
                <th scope="col">Username</th>
                </tr>
            </thead>-->
            <tbody>
                <tr>
                    <th>Hostname</th>
                    <td>
                        {% if hostname %}
                            <a href="https://www.robtex.com/dns-lookup/{{hostname}}">{{hostname}}</a>
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}
                    </td>

                    <th>ISP</th>
                    <td>
                        {% if hostname %}
                            {{isp}}
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}
                        {% if asn and isp %}
                            <!-- TODO: Consider using bgp.he.net -->
                            (<a href="https://bgpview.io/asn/{{asn}}">AS{{asn}}</a>)
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Continent</th>
                    <td>TODO <!-- TODO: Implement this --></td>
                    
                    {% if country %}
                        <th>Flag</th>
                        <td>
                            <a href="https://cdn.rawgit.com/hjnilsson/country-flags/master/svg/{{country|lower}}.svg">
                                <img alt="Flag of {{country_name}}"
                                    src="https://cdn.rawgit.com/hjnilsson/country-flags/master/svg/{{country|lower}}.svg"
                                    class="rounded img-fluid" style="max-width: 35px;" />
                            </a>
                        </td>
                    {% else %}
                        <th></th>
                        <td></td>
                    {% endif %}
                </tr>
                <tr>
                    <th>Country</th>
                    <td>
                        {% if country %}
                            {{country_name}}
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}
                    </td>
                    
                    <th>Country Code</th>
                    <td>
                        {% if country %}
                            {{country}}
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}
                    </td><!-- (TODO: set ISO 3166-1 alpha-3 here) -->
                </tr>
                <tr>
                    <th>Region</th>
                    <td>
                        {% if region %}
                            {{region}}
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}
                    </td>
                    
                    <th>Local time</th>
                    <td>TODO <!-- TODO: Implement this --></td>
                </tr>
                <tr>
                    <th>City</th>
                    <td>
                        {% if city %}
                            {{city}}
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}    
                        </td>
                    
                    <th>Latitude</th>
                    <td>
                        {% if lat %}
                            {{lat}}
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>IP Address<!-- (IPv4)--></th>
                    <td>
                        {% if ip %}
                            {{ip}}
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}
                    </td>
                    
                    <th>Longitude</th>
                    <td>
                        {% if lat %}
                            {{lon}}
                        {% else %}
                            Unknown<!-- TODO: add styles, etc. to this -->
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>

        <form action="" method="get">
            <div class="form-group row">
                <div class="col-md-3 my-auto">
                    <label for="exampleInputEmail1" style="margin-bottom: 0px;">IP Address/Hostname</label>
                </div>
                <div class="col-md-9 row">
                    <div class="col-md-9">
                        <input name="host" type="text" class="form-control" id="exampleInputEmail1" aria-describedby="exampleInputEmail1">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        var loc = {
            lon: {{lon}},
            lat: {{lat}}
        };

        var zoom_level;
        var override_zoom = false;
        var override_zoom_level;
        
        if("{{override_zoom}}" != "") {
            zoom_level = "{{override_zoom}}";
            override_zoom_level = zoom_level;
            override_zoom = true;
        } else {
            // default
            zoom_level = 6;
        }


        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            center: [loc.lon, loc.lat],
            zoom: zoom_level,
        });

        // Add marker to the map.
        if(/* loc.lon != 0 && loc.lon != 0 && */(!override_zoom_level && zoom_level != 0)) {
            new mapboxgl.Marker()
            .setLngLat([{{lon}}, {{lat}}])
            .addTo(map);
        }
        
        // Layer switcher

        var layerList = document.getElementById('menu');
        var inputs = layerList.getElementsByTagName('input');

        function switchLayer(layer) {
            var layerId = layer.target.id;
            map.setStyle('mapbox://styles/mapbox/' + layerId + '-v9');

            if(layerId == "satellite-streets") {
                // Remove active from Streets
                $( "#menu #streets-btn" ).removeClass("active");
                $( "#menu #satellite-streets-btn" ).addClass("active");
            } else if(layerId == "streets") {
                // Remove active class from Satellite Streets
                $( "#menu #satellite-streets-btn" ).removeClass("active");
                $( "#menu #streets-btn" ).addClass("active");
            } else {
                throw "Error: Unknown layer";
            }
        }

        for (var i = 0; i < inputs.length; i++) {
            inputs[i].onclick = switchLayer;
        }

    </script>

    <!-- Add zoom controls to map. -->
    <script src="https://cdn.theel0ja.info/libs/mapbox-gl-disable-map-rotation/dist/script.js"></script>
    <link rel="stylesheet" href="https://cdn.theel0ja.info/libs/mapbox-gl-disable-map-rotation/dist/style.css">
    <script>
        // Add zoom and rotation controls to the map.
        map.addControl(new mapboxgl.NavigationControl());

        // Disable map rotation.
        disableMapRotation(map);
    </script>
{% endblock %}